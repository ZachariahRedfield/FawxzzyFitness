import { promises as fs } from "node:fs";
import path from "node:path";

const ICONS_DIR = path.resolve(process.cwd(), "public/exercises/icons");
const OUTPUT_FILE = path.resolve(process.cwd(), "src/generated/exerciseIconManifest.ts");
const ALLOWED_EXTENSIONS = new Set([".png", ".svg", ".webp"]);

function isAllowedIconFile(fileName) {
  const extension = path.extname(fileName).toLowerCase();
  if (!ALLOWED_EXTENSIONS.has(extension)) {
    return false;
  }

  if (fileName.startsWith("_") && fileName !== "_placeholder.svg") {
    return false;
  }

  return true;
}

async function generateExerciseIconManifest() {
  const entries = await fs.readdir(ICONS_DIR, { withFileTypes: true });
  const slugToExtension = new Map();

  for (const entry of entries) {
    if (!entry.isFile()) continue;

    const fileName = entry.name;
    if (!isAllowedIconFile(fileName)) continue;

    const extension = path.extname(fileName).slice(1).toLowerCase();
    const slug = path.basename(fileName, path.extname(fileName));
    slugToExtension.set(slug, extension);
  }

  const sortedEntries = [...slugToExtension.entries()].sort(([slugA], [slugB]) => slugA.localeCompare(slugB));
  const recordLines = sortedEntries.map(([slug, ext]) => `  ${JSON.stringify(slug)}: ${JSON.stringify(ext)},`);

  const output = `// AUTO-GENERATED FILE. DO NOT EDIT.\n// Generated by scripts/generate-exercise-icon-manifest.mjs\n\nexport const EXERCISE_ICON_EXT_BY_SLUG: Record<string, string> = {\n${recordLines.join("\n")}\n};\n\nexport const EXERCISE_ICON_SLUGS = new Set(Object.keys(EXERCISE_ICON_EXT_BY_SLUG));\n`;

  await fs.mkdir(path.dirname(OUTPUT_FILE), { recursive: true });
  await fs.writeFile(OUTPUT_FILE, output, "utf8");

  console.log(`Generated exercise icon manifest with ${sortedEntries.length} icons at ${path.relative(process.cwd(), OUTPUT_FILE)}`);
}

generateExerciseIconManifest().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
